<html>
<head>

<style type="text/css">
body {
    font-size: 0.8em;
    margin: 0px;
}

body, .inbar {
    background: #212121;
    font-family: tahoma,helvetica,arial,sans-serif;
    color: white;
    overflow: hidden;
}

.bar {
    background: #585858;
    padding: 12px;
    border-radius: 8px;
    margin: auto;
}

.inbar {
    margin: 0px;
    border: 0px;
    padding: 4px;
}

#main {
    position: absolute;
    text-align: center;
    z-index: 0;
}

.sidebar {
    position: absolute;
    margin: 16px auto;
    z-index: 1;
}

#leftbar {
    border-top-left-radius: 0px;
    border-bottom-left-radius: 0px;
    margin-right: 12px;
}

#rightbar {
    border-top-right-radius: 0px;
    border-bottom-right-radius: 0px;
    margin-left: 12px;
}

#chatbar, #rankbar { padding: 0px 4px }
#rankbar { overflow-y: auto }
#chatin { margin-top: 12px }

.handle {
    cursor:pointer;
    text-align: center;
    height: 100%;
    width: 12px;
}

#lhandle { float: right; margin-right: -12px }
#rhandle { float: left;  margin-left:  -12px }

.face { vertical-align: bottom }

</style>

<title>Bomberman JS!</title>
<link rel="shortcut icon" href="bmicon.ico">

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js"></script>
<script src="socket.io/socket.io.min.js"></script>
<script src="bmdraw.js"></script>

<script>

function dbg() {
    console.log('dbg: ' + arguments)
    // this is a hook for chrome's breakpoints
    // and should be removed when finished
} 


var main
    // down: {}
    // up: {}
    // width: 512
    // onmouseup: function(){}
    // onresize: function(){}
    // onload: function(){}

function setmain() {

    main.down[84] = 
    main.down[89] = 
    main.down[85] = 
    main.down[73] = function() { 
        hidel(false)
        hider(false)
        $('#chatin').focus() 
    }

    main.up[219] = hidel
    main.up[221] = hider

    main.onload()
    resize()
    hide()
}

var pixel = 2
var music = true
var sound = true

var lhidden
var rhidden

function hide() {
    var hide = window.innerWidth < (128 + main.width+32)
    hidel(hide)
    hider(hide)
}

function hidel(val) {
    lhidden = val!==undefined ? val : !lhidden
    $('#leftbar').animate({left: lhidden?-$('.sidebar').width()-12:0})
}

function hider(val) {
    rhidden = val!==undefined ? val : !rhidden
    $('#rightbar').animate({right: rhidden?-$('.sidebar').width()-12:0})
}


document.onmouseup = function() { main.onmouseup() }

function keydown(ev) {
    if (main.down[ev.keyCode]) main.down[ev.keyCode](ev.keyCode)
}

function keyup(ev) {
    if (main.up[ev.keyCode]) main.up[ev.keyCode]()
    else console.log(ev.keyCode)
}

function keyfocus() {
    document.onkeydown = keydown
    document.onkeyup = keyup
}

function keyblur() {
    document.onkeydown = null
    document.onkeyup = function(ev) {
        if (ev.keyCode == 27) {
            ev.target.blur()
            hide()
        }   
    }
}

keyfocus()


var socket
function socketinit() {
    socket = new io.Socket()

    socket.on('message',function(msg) {
        for (m in msg) { 
            var data = msg[m]; 
            switch (m) {
                case 'Init':
                    players = {}
                    for (i in data.players)
                        setplayer(data.players[i]) 
                
                    me = data.players[data.id]
                    message('+ '+me.string()+' has joined')
                    rank()
                    resize()
                break
                case 'Join':
                    setplayer(data)
                    message('+ '+data.string()+' has joined')
                    rank()
                    resize()
                break
                case 'Change':
                    if (!players[data.id]) return
                    var p = players[data.id]
                    p.game = data.game
                    message('> '+p.string()+' is now '+
                        (data.game?'playing':'spectating'))
                    rank()
                    resize()
                break
                case 'Chat':
                    if (!players[data.id]) return
                    message(players[data.id].string()+': '+data.msg)
                break
                case 'Disc':
                    if (!players[data]) return
                    message('- '+players[data].string()+' disconnected')
                    delete(players[data])
                    rank()
                    resize()
                break
                case 'Count':
                    $('#main').load('bmgame', setmain)
                break
                case 'Start':
                break
                case 'End':
                    $('#main').load('bmjoin.html', setmain)
                break
            }
        }
    })       
}

var me, players

function setplayer(data) {
    data.name = data.name.replace(/</g,'&lt;')
                         .replace(/>/g,'&gt;')

    data.string = function() {
        return '<span' +
               (this.game?' style="color:'+hue(this.color)+'">':'>') +
               this.name + 
               '</span>'
    }

    data.rank = function() {
        return $('<div>')
            .append(raster(pixmap.face,['#000000',hue2(this.color,0.75),hue(this.color),'#f8b028'],1,16,$('<canvas class=face>')[0]))
            .append(' ' + this.string())
    }

    players[data.id] = data
}


function chat() {
    var v = $('#chatin').val()
    if (/[^ ]/.test(v)) socket.send({chat:v})
    $('#chatin').val('')
    return false
}

function message(data) {
    var bar = $('#chatbar')
    if (data) bar.append('<div>'+data+'</div>')
    while (bar[0].scrollHeight > bar[0].clientHeight)
        bar.children().first().remove()
}

function rank() {
    var bar = $('#rankbar')
    bar.empty()
    for (id in players)
        bar.append(players[id].rank())
}


var resize = window.onresize = function() {
    main.onresize()
    $('#main').css('top',(window.innerHeight-$('#main').innerHeight())/2)
              .css('left',(window.innerWidth-$('#main').innerWidth())/2)

    var hh = $('.sidebar').height(window.innerHeight-56).height()
    $('.inhandle').css('margin-top',(hh-$('.inhandle').height())/2)
    $('#rankbar').height(hh)
    $('#chatbar').height(hh-$('#chatin').innerHeight()-12)

    var ww = (window.innerWidth-main.width-72)/2
    if (ww < 128) ww = 128
    $('.sidebar').width(ww)
    $('#chatin').width(ww-8)
    $('#leftbar').css('left',lhidden? -ww-12 : 0)
    $('#rightbar').css('right',rhidden? -ww-12 : 0)

    message()
}

window.onbeforeunload = function() {
    socket.send({disc:0})
    console.log("disconnecting")
}

window.onload = function() {
    var pl = @2@
    players = {}
    for (i in pl)
        setplayer(pl[i])
    rank()

    socketinit()
    setmain()
}
</script>

</head>
<body>

<div id=rightbar class="bar sidebar">
  <div id=rhandle class=handle onclick="hider()">
    <div class=inhandle>[</div>
  </div>
  <div id=rankbar class=inbar></div>
</div> 

<div id=leftbar class="bar sidebar">
  <div id=lhandle class=handle onclick="hidel()">
    <div class=inhandle>]</div>
  </div>
  <div id=chatbar class=inbar></div>
  <form id=chatform onsubmit="return chat()">
    <input id=chatin class=inbar type=text placeholder="Chat" 
     onfocus="keyblur()" onblur="keyfocus()">
  </form> 
</div>

<div id=main>
    @1 content inserted by bmserver @
</div>

</body>
</html>

