<html>
<head>

<style type="text/css">
body {
    background: #212121;
    font-size: 0.8em;
    font-family: tahoma,helvetica,arial,sans-serif;
    color: white;
    margin: 0px;
    overflow: hidden;
}

.bar {
    background: #585858;
    padding: 12px;
    border-radius: 8px;
    margin: auto;
}

.inbar {
    overflow: hidden;
    background: #212121;
    color: white;
    margin: 0px;
    border: 0px;
    padding: 4px;
}

#main {
    position: absolute;
    text-align: center;
    z-index: 0;
}

.sidebar {
    position: absolute;
    margin: 16px auto;
    z-index: 1;
}

#leftbar {
    border-top-left-radius: 0px;
    border-bottom-left-radius: 0px;
    margin-right: 12px;
}

#rightbar {
    border-top-right-radius: 0px;
    border-bottom-right-radius: 0px;
    margin-left: 12px;
}

#chatbar, #rankbar { padding: 0px 4px }
#rankbar { overflow-y: auto }
#chatin { margin-top: 12px }

.handle {
    cursor:pointer;
    text-align: center;
    height: 100%;
    width: 12px;
}

#lhandle { float: right; margin-right: -12px }
#rhandle { float: left;  margin-left:  -12px }

.face { vertical-align: bottom }

</style>

<title>Bomberman JS!</title>
<link rel="shortcut icon" href="bmicon.ico">

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js"></script>
<script src="socket.io/socket.io.min.js"></script>
<script src="bmdraw.js"></script>

<script>
var resizemain
var mainwidth = 512
var sidewidth = 128

var keys = {down:{}, up:{}}

document.onkeydown = function(ev) {
    if (keys.down[ev.keyCode]) keys.down[ev.keyCode](ev.keyCode)
}

document.onkeyup = function(ev) {
    if (keys.up[ev.keyCode]) keys.up[ev.keyCode](ev.keyCode)
}


var lhidden = window.innerWidth < (sidewidth+mainwidth+32)
var rhidden = lhidden

function hidel() {
    lhidden = !lhidden
    $('#leftbar').animate({left: lhidden?-$('.sidebar').width()-12:0})
}

function hider() {
    rhidden = !rhidden
    $('#rightbar').animate({right: rhidden?-$('.sidebar').width()-12:0})
}

keys.up[219] = hidel
keys.up[221] = hider


var socket
function socketinit() {
    socket = new io.Socket()

    socket.on('message',function(msg) {
        for (m in msg) { var data = msg[m]; switch (m) {
            case 'Init':
                players = {}
                for (i in data.players)
                    addplayer(data.players[i]) 
            
                me = data.players[data.id]
                message('+ '+me.string()+' has joined')
                rank()
                $(window).resize()
            break
            case 'Join':
                addplayer(data)
                message('+ '+data.string()+' has joined')
                rank()
                $(window).resize()
            break
            case 'Change':
                if (!players[data.id]) return
                var p = players[data.id]
                p.game = data.game
                message('> '+p.string()+' is now '+
                    (data.game?'playing':'spectating'))
                rank()
                $(window).resize()
            break
            case 'Chat':
                if (!players[data.id]) return
                message(players[data.id].string()+': '+data.msg)
            break
            case 'Disc':
                if (!players[data]) return
                message('- '+players[data].string()+' disconnected')
                delete(players[data])
                rank()
                $(window).resize()
            break
            case 'Count':
                $('#main').load('bmgame', function() {$(window).resize()})
            break
            case 'Start':
            break
            case 'End':
                $('#main').load('bmjoin.html', function() {$(window).resize()})
            break
        }}
    })       
}

var me, players

function addplayer(data) {
    data.name = data.name.replace(/</g,'&lt;')
                         .replace(/>/g,'&gt;')

    data.string = function() {
        return '<span' +
               (this.game?' style="color:'+hue(this.color)+'">':'>') +
               this.name + 
               '</span>'
    }

    data.rank = function() {
        return $('<div>')
            .append(tile(facetiles,['#000000',hue2(this.color,0.75),hue(this.color),'#f8b028'],1,16,$('<canvas class=face>')[0]))
            .append(' ' + this.string())
    }

    players[data.id] = data
}


function chat() {
    var v = $('#chatin').val()
    if (/[^ ]/.test(v)) socket.send({chat:v})
    $('#chatin').val('')
    return false
}

function message(data) {
    var bar = $('#chatbar')
    if (data) bar.append('<div>'+data+'</div>')
    while (bar[0].scrollHeight > bar[0].clientHeight)
        bar.children().first().remove()
}

function rank() {
    var bar = $('#rankbar')
    bar.empty()
    for (id in players)
        bar.append(players[id].rank())
}


window.onbeforeunload = function() {
    socket.send({disc:0})
    console.log("disconnecting")
}

window.onresize = function() {
    resizemain()
    $('#main')
        .css('top',(window.innerHeight-$('#main').innerHeight())/2)
        .css('left',(window.innerWidth-$('#main').innerWidth())/2)

    var hh = $('.sidebar').height(window.innerHeight-56).height()
    $('.inhandle').css('margin-top',(hh-$('.inhandle').height())/2)
    $('#rankbar').height(hh)
    $('#chatbar').height(hh-$('#chatin').innerHeight()-12)

    var ww = (window.innerWidth-mainwidth-72)/2
    if (ww < sidewidth) ww = sidewidth
    $('.sidebar').width(ww)
    $('#chatin').width(ww-8)
    $('#leftbar').css('left',lhidden? -ww-12 : 0)
    $('#rightbar').css('right',rhidden? -ww-12 : 0)

    message()
}

$(function() {
    var pl = @2@
    players = {}
    for (i in pl)
        addplayer(pl[i])
    rank()

    socketinit()
    $(window).resize()
})
</script>

</head>
<body>

<div id=leftbar class="bar sidebar">
  <div id=lhandle class=handle onclick="hidel()">
    <div class=inhandle>]</div>
  </div>
  <div id=chatbar class=inbar></div>
  <form id=chatform onsubmit="return chat()">
    <input id=chatin class=inbar type=text placeholder="Chat">
  </form> 
</div>

<div id=rightbar class="bar sidebar">
  <div id=rhandle class=handle onclick="hider()">
    <div class=inhandle>[</div>
  </div>
  <div id=rankbar class=inbar></div>
</div> 

<div id=main>
    @1 content inserted by bmserver @
</div>

</body>
</html>

